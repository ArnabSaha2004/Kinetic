# Real Wallet Integration Design

## Overview

This design document outlines the implementation of real wallet connectivity for the Kinetic React Native app, replacing the current mock wallet system with actual integrations to MetaMask Mobile, Trust Wallet, and other WalletConnect-compatible wallets. The solution will use the WalletConnect v2 protocol as the primary connection method, with React Native-specific implementations for deep linking and wallet communication.

## Architecture

### High-Level Architecture

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Kinetic App   │    │  WalletConnect   │    │  Mobile Wallets │
│                 │    │     Bridge       │    │                 │
│ ┌─────────────┐ │    │                  │    │ ┌─────────────┐ │
│ │ Wallet      │ │◄──►│  Session Mgmt    │◄──►│ │ MetaMask    │ │
│ │ Provider    │ │    │  Message Relay   │    │ │ Trust Wallet│ │
│ └─────────────┘ │    │  Deep Linking    │    │ │ Other Wallets│ │
│                 │    │                  │    │ └─────────────┘ │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### Component Architecture

1. **WalletConnectProvider**: Main provider component managing WalletConnect sessions
2. **WalletConnectionManager**: Handles wallet-specific connection logic
3. **DeepLinkHandler**: Manages deep linking to wallet apps
4. **TransactionSigner**: Handles real transaction signing
5. **SessionManager**: Manages WalletConnect session lifecycle

## Components and Interfaces

### Core Interfaces

```typescript
interface RealWalletContextType {
  // Connection state
  address: string | null;
  chainId: number | null;
  isConnected: boolean;
  isConnecting: boolean;
  
  // Connection methods
  connect: (walletType?: WalletType) => Promise<void>;
  disconnect: () => Promise<void>;
  
  // Transaction methods
  signMessage: (message: string) => Promise<string>;
  signTransaction: (transaction: TransactionRequest) => Promise<string>;
  sendTransaction: (transaction: TransactionRequest) => Promise<string>;
  
  // Session management
  session: WalletConnectSession | null;
  reconnect: () => Promise<void>;
}

interface WalletConnectSession {
  topic: string;
  accounts: string[];
  chainId: number;
  metadata: SessionMetadata;
  expiry: number;
}

interface TransactionRequest {
  to: string;
  value?: string;
  data?: string;
  gas?: string;
  gasPrice?: string;
  nonce?: number;
}

enum WalletType {
  METAMASK = 'metamask',
  TRUST_WALLET = 'trust',
  WALLETCONNECT = 'walletconnect'
}
```

### WalletConnect Configuration

```typescript
interface WalletConnectConfig {
  projectId: string; // WalletConnect Cloud project ID
  metadata: {
    name: string;
    description: string;
    url: string;
    icons: string[];
  };
  chains: number[]; // Supported blockchain networks
  methods: string[]; // Supported RPC methods
  events: string[]; // Supported events
}
```

## Data Models

### Wallet Connection State

```typescript
interface WalletState {
  // Connection status
  status: 'disconnected' | 'connecting' | 'connected' | 'error';
  
  // Wallet information
  address: string | null;
  chainId: number | null;
  walletType: WalletType | null;
  
  // Session data
  session: WalletConnectSession | null;
  
  // Error handling
  error: WalletError | null;
  lastConnectionAttempt: number | null;
}

interface WalletError {
  code: string;
  message: string;
  details?: any;
  retryable: boolean;
}
```

### Transaction State

```typescript
interface TransactionState {
  // Transaction status
  status: 'idle' | 'pending' | 'signed' | 'sent' | 'confirmed' | 'failed';
  
  // Transaction data
  hash: string | null;
  signature: string | null;
  
  // Error handling
  error: TransactionError | null;
}
```

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property 1: Real wallet address consistency
*For any* successful wallet connection, the displayed address should match exactly the address provided by the connected wallet app, never showing mock or hardcoded addresses
**Validates: Requirements 1.2, 2.2**

### Property 2: Transaction signature authenticity  
*For any* transaction signing request, the returned signature should be cryptographically valid and generated by the actual connected wallet, not mock data
**Validates: Requirements 3.3**

### Property 3: WalletConnect session integrity
*For any* active WalletConnect session, the session data should remain consistent and valid throughout the connection lifecycle until explicitly disconnected
**Validates: Requirements 4.3**

### Property 4: Mock data elimination
*For any* wallet operation in production mode, the system should never use hardcoded addresses, mock signatures, or simulated wallet responses
**Validates: Requirements 5.1, 5.2, 5.3**

### Property 5: Deep link wallet targeting
*For any* wallet selection, the deep link should open the correct wallet app and establish a connection with that specific wallet
**Validates: Requirements 1.1, 2.1**

### Property 6: Connection state consistency
*For any* wallet connection state change, the UI should accurately reflect the actual connection status without showing connected state for mock connections
**Validates: Requirements 1.3, 2.3**

### Property 7: Error message specificity
*For any* wallet connection failure, the error message should provide specific, actionable information about the failure cause rather than generic error text
**Validates: Requirements 6.1, 6.2**

### Property 8: Session cleanup completeness
*For any* wallet disconnection, all session data, cached addresses, and connection state should be completely cleared from the app
**Validates: Requirements 1.4, 4.4**

## Error Handling

### Error Categories

1. **Connection Errors**
   - Wallet app not installed
   - User rejection of connection
   - Network connectivity issues
   - WalletConnect bridge failures

2. **Transaction Errors**
   - User rejection of transaction
   - Insufficient funds
   - Network congestion
   - Invalid transaction parameters

3. **Session Errors**
   - Session expiration
   - Wallet app closure
   - Network disconnection
   - Protocol version mismatch

### Error Recovery Strategies

1. **Automatic Retry**: For network-related errors
2. **User Guidance**: For installation and setup issues
3. **Graceful Degradation**: Maintain app functionality when wallet unavailable
4. **Session Restoration**: Attempt to restore sessions on app restart

## Testing Strategy

### Unit Testing Approach

Unit tests will focus on:
- WalletConnect session management logic
- Deep link URL generation and parsing
- Error handling and recovery mechanisms
- State management and transitions
- Configuration validation

### Property-Based Testing Approach

Property-based tests will verify:
- Real wallet address consistency across all connection types
- Transaction signature authenticity for all signing operations
- Session integrity throughout connection lifecycle
- Complete elimination of mock data in all scenarios
- Proper error message generation for all failure cases

The property-based testing will use **react-native-testing-library** and **@fast-check/jest** for generating random test scenarios and validating universal properties across different wallet types, network conditions, and user interactions.

### Integration Testing

Integration tests will cover:
- End-to-end wallet connection flows
- Real transaction signing with test wallets
- Deep linking between apps
- Session persistence across app restarts
- Multi-wallet support scenarios

### Testing Configuration

- **Minimum iterations per property test**: 100
- **Test wallet setup**: Use testnet wallets for integration testing
- **Mock isolation**: Ensure no mock data leaks into real wallet tests
- **Platform testing**: Verify Android-specific deep linking behavior

## Implementation Dependencies

### Required Libraries

1. **@walletconnect/react-native-compat**: WalletConnect v2 React Native support
2. **@walletconnect/core**: Core WalletConnect functionality
3. **@walletconnect/web3wallet**: Web3 wallet integration
4. **react-native-url-polyfill**: URL polyfill for React Native
5. **@react-native-async-storage/async-storage**: Session persistence
6. **react-native-get-random-values**: Crypto random values polyfill

### Configuration Requirements

1. **WalletConnect Cloud Project**: Register project and obtain project ID
2. **Deep Link Schemes**: Configure app URL schemes for wallet returns
3. **Android Manifest**: Add intent filters for deep linking
4. **iOS Info.plist**: Configure URL schemes and LSApplicationQueriesSchemes

### Network Configuration

- **Supported Networks**: Ethereum Mainnet, Polygon, Base
- **RPC Endpoints**: Configure reliable RPC providers
- **Chain IDs**: 1 (Ethereum), 137 (Polygon), 8453 (Base)

## Security Considerations

### Session Security

1. **Session Encryption**: All WalletConnect sessions use end-to-end encryption
2. **Session Expiry**: Implement proper session timeout and renewal
3. **Key Management**: Secure storage of session keys and metadata

### Transaction Security

1. **Transaction Validation**: Validate all transaction parameters before signing
2. **User Confirmation**: Always require explicit user approval for transactions
3. **Network Verification**: Verify transaction on correct network

### Data Protection

1. **No Private Key Storage**: Never store or handle private keys in the app
2. **Session Isolation**: Isolate wallet sessions from other app data
3. **Secure Communication**: Use HTTPS for all external communications

## Performance Considerations

### Connection Optimization

1. **Session Caching**: Cache valid sessions to avoid repeated connections
2. **Background Reconnection**: Attempt reconnection when app becomes active
3. **Timeout Management**: Implement reasonable timeouts for connection attempts

### Memory Management

1. **Session Cleanup**: Properly dispose of unused sessions
2. **Event Listener Management**: Clean up WalletConnect event listeners
3. **State Optimization**: Minimize wallet state storage

## Migration Strategy

### Phase 1: Parallel Implementation
- Implement real wallet provider alongside existing mock provider
- Add feature flag to switch between implementations
- Test real wallet functionality without affecting current users

### Phase 2: Gradual Rollout
- Enable real wallet integration for test users
- Monitor connection success rates and error patterns
- Gather user feedback on wallet connection experience

### Phase 3: Full Migration
- Remove mock wallet implementation completely
- Update all references to use real wallet provider
- Deploy to production with real wallet functionality only

### Rollback Plan
- Maintain ability to quickly revert to mock implementation
- Keep mock provider code in separate branch for emergency rollback
- Monitor key metrics during migration for early issue detection